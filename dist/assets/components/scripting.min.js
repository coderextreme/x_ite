!function(){const t=window[Symbol.for("X_ITE.X3D-7.0.0")],e=t.define,i=t.require;e("x_ite/Browser/Scripting/evaluate",[],(function(){"use strict";return function(t,e){return Function(`with (arguments [0])\n      {\n         delete arguments [0];\n         arguments .length = 0;\n         ${e}\n      }`)(t)}})),e("x_ite/Components/Scripting/X3DScriptNode",["x_ite/Components/Core/X3DChildNode","x_ite/Components/Networking/X3DUrlObject","x_ite/Base/X3DConstants"],(function(t,e,i){"use strict";function n(n){t.call(this,n),e.call(this,n),this.addType(i.X3DScriptNode)}return n.prototype=Object.assign(Object.create(t.prototype),e.prototype,{constructor:n}),n})),e("x_ite/Components/Scripting/Script",["jquery","x_ite/Base/X3DFieldDefinition","x_ite/Base/FieldDefinitionArray","x_ite/Base/X3DField","x_ite/Base/X3DArrayField","x_ite/Fields","x_ite/Browser/X3DBrowser","x_ite/Configuration/ComponentInfo","x_ite/Configuration/ComponentInfoArray","x_ite/Configuration/ProfileInfo","x_ite/Configuration/ProfileInfoArray","x_ite/Configuration/UnitInfo","x_ite/Configuration/UnitInfoArray","x_ite/Execution/X3DExecutionContext","x_ite/Execution/X3DScene","x_ite/Prototype/ExternProtoDeclarationArray","x_ite/Prototype/ProtoDeclarationArray","x_ite/Prototype/X3DExternProtoDeclaration","x_ite/Prototype/X3DProtoDeclaration","x_ite/Routing/RouteArray","x_ite/Routing/X3DRoute","x_ite/Browser/Scripting/evaluate","x_ite/Components/Scripting/X3DScriptNode","x_ite/InputOutput/FileLoader","x_ite/Base/X3DConstants"],(function(t,e,i,n,o,r,s,a,c,u,l,p,d,f,h,v,F,g,S,_,x,m,y,M,D){function w(t){y.call(this,t),this.addType(D.Script),this.pauseTime=0}return w.prototype=Object.assign(Object.create(y.prototype),{constructor:w,[Symbol.for("X_ITE.X3DBaseNode.fieldDefinitions")]:new i([new e(D.inputOutput,"metadata",new r.SFNode),new e(D.inputOutput,"load",new r.SFBool(!0)),new e(D.inputOutput,"url",new r.MFString),new e(D.inputOutput,"autoRefresh",new r.SFTime),new e(D.inputOutput,"autoRefreshTimeLimit",new r.SFTime(3600)),new e(D.initializeOnly,"directOutput",new r.SFBool),new e(D.initializeOnly,"mustEvaluate",new r.SFBool)]),getTypeName:function(){return"Script"},getComponentName:function(){return"Scripting"},getContainerField:function(){return"children"},initialize:function(){y.prototype.initialize.call(this);for(const t of this.getUserDefinedFields())t.setModificationTime(0);this.requestImmediateLoad()},getExtendedEventHandling:function(){return!1},canUserDefinedFields:function(){return!0},addUserDefinedField:function(t,e,i){y.prototype.addUserDefinedField.call(this,t,e,i),this.isInitialized()&&(this.setLoadState(D.NOT_STARTED_STATE),this.requestImmediateLoad())},removeUserDefinedField:function(t){y.prototype.removeUserDefinedField.call(this,t),this.isInitialized()&&(this.setLoadState(D.NOT_STARTED_STATE),this.requestImmediateLoad())},getSourceText:function(){return this._url},unLoadNow:function(){this.initialize__("")},loadNow:function(){this.initialized=!1,new M(this).loadScript(this._url,function(t){null===t?this.setLoadState(D.FAILED_STATE):(this.setLoadState(D.COMPLETE_STATE),this.initialize__(t))}.bind(this))},getContext:function(t){try{const e=["initialize","prepareEvents","eventsProcessed","shutdown"];for(const t of this.getUserDefinedFields())switch(t.getAccessType()){case D.inputOnly:e.push(t.getName());break;case D.inputOutput:e.push("set_"+t.getName())}t+="\nreturn ["+e.map((function(t){return`typeof ${t} !== "undefined" ? ${t} : undefined`})).join(",")+"];",this.global=this.getGlobal();const i=this.evaluate(t),n={};for(let t=0;t<e.length;++t)n[e[t]]=i[t];return n}catch(t){return this.setError("while evaluating script source",t),{}}},evaluate:function(t){return m(this.global,t)},getGlobal:function(){const t=this.getBrowser(),m=this.getExecutionContext(),y=this.isLive();function M(e){const i=t.createX3DFromString(String(e)),n=i.getRootNodes();if(y.addFieldInterest(i.isLive()),i.setLive(y.getValue()),i.setPrivate(m.isPrivate()),i.setExecutionContext(m),n.length&&n[0])return n[0];throw new Error("SFNode.new: invalid argument, must be 'string' is 'undefined'.")}M.prototype=r.SFNode.prototype;const w={NULL:{value:null},FALSE:{value:!1},TRUE:{value:!0},print:{value:t.println.bind(t)},trace:{value:t.println.bind(t)},Browser:{value:t},X3DConstants:{value:D},X3DBrowser:{value:s},X3DExecutionContext:{value:f},X3DScene:{value:h},ComponentInfo:{value:a},ComponentInfoArray:{value:c},ProfileInfo:{value:u},ProfileInfoArray:{value:l},UnitInfo:{value:p},UnitInfoArray:{value:d},ExternProtoDeclarationArray:{value:v},ProtoDeclarationArray:{value:F},X3DExternProtoDeclaration:{value:g},X3DProtoDeclaration:{value:S},RouteArray:{value:_},X3DRoute:{value:x},X3DFieldDefinition:{value:e},FieldDefinitionArray:{value:i},X3DField:{value:n},X3DArrayField:{value:o},SFColor:{value:r.SFColor},SFColorRGBA:{value:r.SFColorRGBA},SFImage:{value:r.SFImage},SFMatrix3d:{value:r.SFMatrix3d},SFMatrix3f:{value:r.SFMatrix3f},SFMatrix4d:{value:r.SFMatrix4d},SFMatrix4f:{value:r.SFMatrix4f},SFNode:{value:M},SFRotation:{value:r.SFRotation},SFVec2d:{value:r.SFVec2d},SFVec2f:{value:r.SFVec2f},SFVec3d:{value:r.SFVec3d},SFVec3f:{value:r.SFVec3f},SFVec4d:{value:r.SFVec4d},SFVec4f:{value:r.SFVec4f},VrmlMatrix:{value:r.VrmlMatrix},MFBool:{value:r.MFBool},MFColor:{value:r.MFColor},MFColorRGBA:{value:r.MFColorRGBA},MFDouble:{value:r.MFDouble},MFFloat:{value:r.MFFloat},MFImage:{value:r.MFImage},MFInt32:{value:r.MFInt32},MFMatrix3d:{value:r.MFMatrix3d},MFMatrix3f:{value:r.MFMatrix3f},MFMatrix4d:{value:r.MFMatrix4d},MFMatrix4f:{value:r.MFMatrix4f},MFNode:{value:r.MFNode},MFRotation:{value:r.MFRotation},MFString:{value:r.MFString},MFTime:{value:r.MFTime},MFVec2d:{value:r.MFVec2d},MFVec2f:{value:r.MFVec2f},MFVec3d:{value:r.MFVec3d},MFVec3f:{value:r.MFVec3f},MFVec4d:{value:r.MFVec4d},MFVec4f:{value:r.MFVec4f}};for(const t of this.getUserDefinedFields()){const e=t.getName();t.getAccessType()!==D.inputOnly&&(e in w||(w[e]={get:t.valueOf.bind(t),set:t.setValue.bind(t)}),t.getAccessType()===D.inputOutput&&(w[e+"_changed"]={get:t.valueOf.bind(t),set:t.setValue.bind(t)}))}return Object.create(Object.prototype,w)},processOutstandingEvents:function(){for(const t of this.getUserDefinedFields())if(!(t.getModificationTime()<=this.pauseTime))switch(t.getAccessType()){case D.inputOnly:{const e=this.context[t.getName()];"function"==typeof e&&this.set_field__(e,t);break}case D.inputOutput:{const e=this.context["set_"+t.getName()];"function"==typeof e&&this.set_field__(e,t);break}}},initialize__:function(t){this.context=this.getContext(t),this.set_live__()},set_live__:function(){if(y.prototype.set_live__.call(this),this.context)if(this.isLive().getValue()){if(!this.initialized){if(this.initialized=!0,"function"==typeof this.context.initialize){const t=this.getBrowser();t.getScriptStack().push(this);try{this.context.initialize()}catch(t){this.setError("in function 'initialize'",t)}t.getScriptStack().pop()}"function"==typeof this.context.shutdown&&t(window).on("unload",this.shutdown__.bind(this))}"function"==typeof this.context.prepareEvents&&this.getBrowser().prepareEvents().addInterest("prepareEvents__",this),"function"==typeof this.context.eventsProcessed&&this.addInterest("eventsProcessed__",this);for(const t of this.getUserDefinedFields())switch(t.getAccessType()){case D.inputOnly:{const e=this.context[t.getName()];"function"==typeof e&&t.addInterest("set_field__",this,e);break}case D.inputOutput:{const e=this.context["set_"+t.getName()];"function"==typeof e&&t.addInterest("set_field__",this,e);break}}this.processOutstandingEvents()}else{this.context.prepareEvents&&this.getBrowser().prepareEvents().removeInterest("prepareEvents__",this),this.context.eventsProcessed&&this.removeInterest("eventsProcessed__",this);for(const t of this.getUserDefinedFields())switch(t.getAccessType()){case D.inputOnly:case D.inputOutput:t.removeInterest("set_field__",this)}this.initialized&&(this.pauseTime=performance.now())}},prepareEvents__:function(){const t=this.getBrowser();t.getScriptStack().push(this);try{this.context.prepareEvents(t.getCurrentTime()),t.addBrowserEvent()}catch(t){this.setError("in function 'prepareEvents'",t)}t.getScriptStack().pop()},set_field__:function(t,e){const i=this.getBrowser();e.setTainted(!0),i.getScriptStack().push(this);try{t(e.valueOf(),i.getCurrentTime())}catch(t){this.setError("in function '"+e.getName()+"'",t)}i.getScriptStack().pop(),e.setTainted(!1)},eventsProcessed__:function(){const t=this.getBrowser();t.getScriptStack().push(this);try{this.context.eventsProcessed()}catch(t){this.setError("in function 'eventsProcessed'",t)}t.getScriptStack().pop()},shutdown__:function(){const t=this.getBrowser();t.getScriptStack().push(this);try{this.context.shutdown()}catch(t){this.setError("in function 'shutdown'",t)}t.getScriptStack().pop()},setError:function(t,e){console.error("JavaScript Error in Script '"+this.getName()+"', "+t+"\nworld url is '"+this.getExecutionContext().getWorldURL()+"':"),console.error(e)}}),w})),e(i.getComponentUrl("scripting"),["x_ite/Components","x_ite/Components/Scripting/Script","x_ite/Components/Scripting/X3DScriptNode"],(function(t,e,i){"use strict";t.addComponent({name:"Scripting",types:{Script:e},abstractTypes:{X3DScriptNode:i}})}))}();
