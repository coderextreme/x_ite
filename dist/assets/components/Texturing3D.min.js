(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Components");var n=t.n(e);const r=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Fields");var i=t.n(r);const o=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Base/X3DFieldDefinition");var a=t.n(o);const s=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Base/FieldDefinitionArray");var h=t.n(s);const c=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Components/Texturing/X3DSingleTextureNode");var u=t.n(c);const l=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Base/X3DConstants");var d=t.n(l);const f=new Uint8Array([255,255,255,255]);function p(t){u().call(this,t),this.addType(d().X3DTexture3DNode);const e=this.getBrowser().getContext();this.target=e.TEXTURE_3D,this.width=0,this.height=0,this.depth=0,this.data=null}p.prototype=Object.assign(Object.create(u().prototype),{constructor:p,initialize:function(){u().prototype.initialize.call(this),this._repeatS.addInterest("updateTextureParameters",this),this._repeatT.addInterest("updateTextureParameters",this),this._repeatR.addInterest("updateTextureParameters",this);const t=this.getBrowser().getContext();t.getVersion()<2||(t.bindTexture(t.TEXTURE_3D,this.getTexture()),t.texImage3D(t.TEXTURE_3D,0,t.RGBA,1,1,1,0,t.RGBA,t.UNSIGNED_BYTE,f))},getTarget:function(){return this.target},getTextureType:function(){return 3},getTextureTypeString:function(){return"3D"},getWidth:function(){return this.width},getHeight:function(){return this.height},getDepth:function(){return this.depth},getFlipY:function(){return!1},getData:function(){return this.data},clearTexture:function(){const t=this.getBrowser().getContext();this.setTexture(1,1,1,!1,t.RGBA,f),this.data=null},setTexture:function(t,e,n,r,i,o){this.width=t,this.height=e,this.depth=n,this.data=o;const a=this.getBrowser().getContext();a.getVersion()<2||(a.bindTexture(a.TEXTURE_3D,this.getTexture()),a.texImage3D(a.TEXTURE_3D,0,i,t,e,n,0,i,a.UNSIGNED_BYTE,o),this.setTransparent(r),this.updateTextureParameters(),this.addNodeEvent())},updateTextureParameters:function(){u().prototype.updateTextureParameters.call(this,this.target,this._textureProperties.getValue(),this.texturePropertiesNode,this.width,this.height,this._repeatS.getValue(),this._repeatT.getValue(),this._repeatR.getValue())},setShaderUniforms:function(t,e,n,r=e.x3d_Texture[0]){const i=this.getBrowser().getTexture3DUnit();t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_3D,this.getTexture()),t.uniform1i(r.texture3D,i)}});const g=p,m=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Base/X3DCast");var w=t.n(m);function b(t){g.call(this,t),this.addType(d().ComposedTexture3D),this.addChildObjects("loadState",new(i().SFInt32)(d().NOT_STARTED_STATE)),this.textureNodes=[]}b.prototype=Object.assign(Object.create(g.prototype),{constructor:b,[Symbol.for("X_ITE.X3DBaseNode.fieldDefinitions")]:new(h())([new(a())(d().inputOutput,"metadata",new(i().SFNode)),new(a())(d().inputOutput,"description",new(i().SFString)),new(a())(d().initializeOnly,"repeatS",new(i().SFBool)),new(a())(d().initializeOnly,"repeatT",new(i().SFBool)),new(a())(d().initializeOnly,"repeatR",new(i().SFBool)),new(a())(d().initializeOnly,"textureProperties",new(i().SFNode)),new(a())(d().inputOutput,"texture",new(i().MFNode))]),getTypeName:function(){return"ComposedTexture3D"},getComponentName:function(){return"Texturing3D"},getContainerField:function(){return"texture"},initialize:function(){g.prototype.initialize.call(this),this._texture.addInterest("set_texture__",this),this.set_texture__()},checkLoadState:function(){return this._loadState.getValue()},set_texture__:function(){const t=this.textureNodes;for(const e of t)e.removeInterest("update",this);t.length=0;for(const e of this._texture){const n=w()(d().X3DTexture2DNode,e);n&&t.push(n)}for(const e of t)e.addInterest("update",this);this.update()},update:function(){const t=this.textureNodes,e=t.every((function(t){return t.checkLoadState()===d().COMPLETE_STATE}));if(0!==t.length&&e){const e=this.getBrowser().getContext(),n=t[0],r=n.getWidth(),i=n.getHeight(),o=t.length,a=r*i*4,s=new Uint8Array(a*o);let h=0;for(let t=0,e=0;t<o;++t,e+=a){const n=this.textureNodes[t],o=n.getData();n.getWidth()===r&&n.getHeight()===i?(h+=n.getTransparent(),s.set(o,e)):console.log("ComposedTexture3D: all textures must have same size.")}this.setTexture(r,i,o,!!h,e.RGBA,s),this._loadState=d().COMPLETE_STATE}else this.clearTexture(),this._loadState=d().FAILED_STATE}});const y=b,T=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Components/Networking/X3DUrlObject");var x,D,v,_,C=t.n(T),A={NRRD:new RegExp("^NRRD(\\d+)\\n","gy"),field:new RegExp("([\\w\\s]+):\\s*(.+?)\\n","gy"),comment:new RegExp("#[^\\n]*\\n","gy"),newLine:new RegExp("\n","gy"),data:new RegExp("([^]*)$","gy")};function E(t){return this.lastIndex=t.lastIndex,t.result=this.exec(t.input),!!t.result&&(t.lastIndex=this.lastIndex,!0)}for(var S in A)A[S].parse=E;function I(){this.fieldFunction=new Map([["type",this.getType],["encoding",this.getEncoding],["dimension",this.getDimension],["sizes",this.getSizes],["endian",this.getEndian]])}I.prototype={parse:function(t){return this.setInput(t),this.getNRRD()&&(this.getFields(),this.getData()),this.nrrd},setInput:function(t){this.input=t,this.lastIndex=0,this.nrrd={},this.endian="little"},getNRRD:function(){return A.NRRD.parse(this)?(this.nrrd.nrrd=!0,this.nrrd.version=parseInt(this.result[1]),this.endian=this.getEndianess(),!0):(this.nrrd.nrrd=!1,!1)},getFields:function(){for(;A.comment.parse(this););for(;A.field.parse(this);){var t=this.result[1].toLowerCase(),e=this.result[2].trim().toLowerCase(),n=this.fieldFunction.get(t);for(n&&n.call(this,e);A.comment.parse(this););}},getType:(_=new Map([["signed char",["signed char",1]],["int8",["signed char",1]],["int8_t",["signed char",1]],["uchar",["unsigned char",1]],["unsigned char",["unsigned char",1]],["uint8",["unsigned char",1]],["uint8_t",["unsigned char",1]],["short",["signed short",2]],["short int",["signed short",2]],["signed short",["signed short",2]],["signed short int",["signed short",2]],["int16",["signed short",2]],["int16_t",["signed short",2]],["ushort",["unsigned short",2]],["unsigned short",["unsigned short",2]],["unsigned short int",["unsigned short",2]],["uint16",["unsigned short",2]],["uint16_t",["unsigned short",2]],["int",["signed int",4]],["signed int",["signed int",4]],["int32",["signed int",4]],["int32_t",["signed int",4]],["uint",["unsigned int",4]],["unsigned int",["unsigned int",4]],["uint32",["unsigned int",4]],["uint32_t",["unsigned int",4]],["float",["float",4]],["double",["double",8]]]),function(t){var e=_.get(t);if(void 0===e)throw new Error("Unsupported NRRD type '"+t+"'.");this.byteType=e[0],this.bytes=e[1]}),getEncoding:(v=new Map([["ascii","ascii"],["txt","ascii"],["text","ascii"],["raw","raw"],["hex","hex"],["gz","gzip"],["gzip","gzip"]]),function(t){var e=v.get(t);if(void 0===e)throw new Error("Unsupported NRRD encoding '"+t+"'.");this.encoding=e}),getDimension:function(t){var e=t.match(/(\d+)/),n=0;if(e)switch(n=parseInt(e[1])){case 1:case 2:case 3:case 4:return void(this.dimension=n)}throw new Error("Unsupported NRRD dimension '"+n+"', must be 1, 2, 3, or 4.")},getSizes:function(t){for(var e=new RegExp("\\s*(\\d+)","gy"),n=null,r=[];n=e.exec(t);)r.push(parseInt(n[1]));switch(r.length){case 1:return this.nrrd.components=1,this.nrrd.width=r[0],this.nrrd.height=1,void(this.nrrd.depth=1);case 2:return this.nrrd.components=1,this.nrrd.width=r[0],this.nrrd.height=r[1],void(this.nrrd.depth=1);case 3:return this.nrrd.components=1,this.nrrd.width=r[0],this.nrrd.height=r[1],void(this.nrrd.depth=r[2]);case 4:return this.nrrd.components=r[0],this.nrrd.width=r[1],this.nrrd.height=r[2],void(this.nrrd.depth=r[3]);default:throw new Error("Unsupported NRRD sizes.")}},getEndian:function(t){if("little"!==t&&"big"!==t)throw new Error("Unsupported NRRD endian, must be 'little' or 'big'.");this.endian=t},getData:function(){switch(this.encoding){case"ascii":this.ascii();break;case"raw":this.rawString(this.input);break;case"hex":this.hex();break;case"gzip":this.gzip()}},ascii:function(){var t=this.nrrd.components*this.nrrd.width*this.nrrd.height*this.nrrd.depth,e=new Uint8Array(t);if(this.nrrd.data=e,A.data.parse(this)){var n=this.result[1].trim().split(/\s+/);switch(this.byteType){case"signed char":case"unsigned char":return void n.forEach((function(t,n){e[n]=parseInt(t)}));case"signed short":case"unsigned short":return void n.forEach((function(t,n){e[n]=parseInt(t)/256}));case"signed int":case"unsigned int":return void n.forEach((function(t,n){e[n]=parseInt(t)/16777216}));case"float":return void n.forEach((function(t,n){e[n]=parseFloat(t)/256}));case"double":return void n.forEach((function(t,n){e[n]=parseFloat(t)/16777216}))}}},rawString:function(t){var e=this.nrrd.components*this.nrrd.width*this.nrrd.height*this.nrrd.depth,n=e*this.bytes,r=new Uint8Array(e);switch(this.nrrd.data=r,this.byteType){case"signed char":case"unsigned char":for(var i=t.length-n,o=0;i<t.length;++i,++o)r[o]=t.charCodeAt(i);return;case"signed short":case"unsigned short":if(this.getEndianess()===this.endian)var a=0,s=1;else a=1,s=0;for(i=t.length-n,o=0;i<t.length;i+=2,++o)r[o]=this.short2byte(t.charCodeAt(i+a),t.charCodeAt(i+s));return;case"signed int":case"unsigned int":if(this.getEndianess()===this.endian){a=0,s=1;var h=2,c=3}else a=3,s=2,h=1,c=0;for(i=t.length-n,o=0;i<t.length;i+=4,++o)r[o]=this.int2byte(t.charCodeAt(i+a),t.charCodeAt(i+s),t.charCodeAt(i+h),t.charCodeAt(i+c));return;case"float":if(this.getEndianess()===this.endian)a=0,s=1,h=2,c=3;else a=3,s=2,h=1,c=0;for(i=t.length-n,o=0;i<t.length;i+=4,++o)r[o]=this.float2byte(t.charCodeAt(i+a),t.charCodeAt(i+s),t.charCodeAt(i+h),t.charCodeAt(i+c));return;case"double":if(this.getEndianess()===this.endian){a=0,s=1,h=2,c=3;var u=4,l=5,d=6,f=7}else a=7,s=6,h=5,c=4,u=3,l=2,d=1,f=0;for(i=t.length-n,o=0;i<t.length;i+=8,++o)r[o]=this.double2byte(t.charCodeAt(i+a),t.charCodeAt(i+s),t.charCodeAt(i+h),t.charCodeAt(i+c),t.charCodeAt(i+u),t.charCodeAt(i+l),t.charCodeAt(i+d),t.charCodeAt(i+f));return}},rawArray:function(t){var e=this.nrrd.components*this.nrrd.width*this.nrrd.height*this.nrrd.depth,n=e*this.bytes,r=new Uint8Array(e);switch(this.nrrd.data=r,this.byteType){case"signed char":case"unsigned char":for(var i=t.length-n,o=0;i<t.length;++i,++o)r[o]=t[i];return;case"signed short":case"unsigned short":if(this.getEndianess()===this.endian)var a=0,s=1;else a=1,s=0;for(i=t.length-n,o=0;i<t.length;i+=2,++o)r[o]=this.short2byte(t[i+a],t[i+s]);return;case"signed int":case"unsigned int":if(this.getEndianess()===this.endian){a=0,s=1;var h=2,c=3}else a=3,s=2,h=1,c=0;for(i=t.length-n,o=0;i<t.length;i+=4,++o)r[o]=this.int2byte(t[i+a],t[i+s],t[i+h],t[i+c]);return;case"float":if(this.getEndianess()===this.endian)a=0,s=1,h=2,c=3;else a=3,s=2,h=1,c=0;for(i=t.length-n,o=0;i<t.length;i+=4,++o)r[o]=this.float2byte(t[i+a],t[i+s],t[i+h],t[i+c]);return;case"double":if(this.getEndianess()===this.endian){a=0,s=1,h=2,c=3;var u=4,l=5,d=6,f=7}else a=7,s=6,h=5,c=4,u=3,l=2,d=1,f=0;for(i=t.length-n,o=0;i<t.length;i+=8,++o)r[o]=this.double2byte(t[i+a],t[i+s],t[i+h],t[i+c],t[i+u],t[i+l],t[i+d],t[i+f]);return}},hex:function(){if(A.data.parse(this)){var t=this.result[1].match(/([0-9a-fA-F]{2})/g);if(t){var e=t.map((function(t){return parseInt(t,16)}));return void this.rawArray(e)}}throw new Error("Invalid NRRD data.")},gzip:function(){try{if(!A.newLine.parse(this))throw new Error("Invalid NRRD data.");A.data.parse(this);const t=this.binaryStringToBuffer(this.result[1]),e=pako.ungzip(t,{to:"raw"});this.rawArray(e)}catch(t){throw new Error("Invalid NRRD data.")}},binaryStringToBuffer:function(t){const e=new Uint8Array(t.length);for(let n=0,r=t.length;n<r;++n)e[n]=t.charCodeAt(n);return e},getEndianess:function(){var t=new ArrayBuffer(4),e=new Uint32Array(t),n=new Uint8Array(t);if(e[0]=16909060,1==n[0]&&2==n[1]&&3==n[2]&&4==n[3])return"big";if(4==n[0]&&3==n[1]&&2==n[2]&&1==n[3])return"little";throw new Error("NRRD: unkown system endianess,")},short2byte:(x=new Uint8Array(2),D=new Uint16Array(x.buffer),function(t,e){return x[0]=t,x[1]=e,D[0]/256}),int2byte:function(){var t=new Uint8Array(4),e=new Uint32Array(t.buffer);return function(n,r,i,o){return t[0]=n,t[1]=r,t[2]=i,t[3]=o,e[0]/16777216}}(),float2byte:function(){var t=new Uint8Array(4),e=new Float32Array(t.buffer);return function(n,r,i,o){return t[0]=n,t[1]=r,t[2]=i,t[3]=o,e[0]/256}}(),double2byte:function(){var t=new Uint8Array(8),e=new Float64Array(t.buffer);return function(n,r,i,o,a,s,h,c){return t[0]=n,t[1]=r,t[2]=i,t[3]=o,t[4]=a,t[5]=s,t[6]=h,t[7]=c,e[0]/16777216}}()};const P=I;var L={Unkown:0,Grayscale:1,AdobeRGB:2,RGB:3,CYMK:4};const O=function(){var t=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),e=4017,n=799,r=3406,i=2276,o=1567,a=3784,s=5793,h=2896;function c(){}function u(t,e){for(var n,r,i=0,o=[],a=16;a>0&&!t[a-1];)a--;o.push({children:[],index:0});var s,h=o[0];for(n=0;n<a;n++){for(r=0;r<t[n];r++){for((h=o.pop()).children[h.index]=e[i];h.index>0;)h=o.pop();for(h.index++,o.push(h);o.length<=n;)o.push(s={children:[],index:0}),h.children[h.index]=s.children,h=s;i++}n+1<a&&(o.push(s={children:[],index:0}),h.children[h.index]=s.children,h=s)}return o[0].children}function l(t,e,n){return 64*((t.blocksPerLine+1)*e+n)}function d(e,n,r,i,o,a,s,h,c){r.precision,r.samplesPerLine,r.scanLines;var u=r.mcusPerLine,d=r.progressive,f=(r.maxH,r.maxV,n),p=0,g=0;function m(){if(g>0)return g--,p>>g&1;if(255==(p=e[n++])){var t=e[n++];if(t)throw"unexpected marker: "+(p<<8|t).toString(16)}return g=7,p>>>7}function w(t){for(var e,n=t;null!==(e=m());){if("number"==typeof(n=n[e]))return n;if("object"!=typeof n)throw"invalid huffman sequence"}return null}function b(t){for(var e=0;t>0;){var n=m();if(null===n)return;e=e<<1|n,t--}return e}function y(t){var e=b(t);return e>=1<<t-1?e:e+(-1<<t)+1}var T=0;var x,D=0;function v(t,e,n,r,i){var o=n%u;e(t,l(t,(n/u|0)*t.v+r,o*t.h+i))}function _(t,e,n){e(t,l(t,n/t.blocksPerLine|0,n%t.blocksPerLine))}var C,A,E,S,I,P,L=i.length;P=d?0===a?0===h?function(t,e){var n=w(t.huffmanTableDC),r=0===n?0:y(n)<<c;t.blockData[e]=t.pred+=r}:function(t,e){t.blockData[e]|=m()<<c}:0===h?function(e,n){if(T>0)T--;else for(var r=a,i=s;r<=i;){var o=w(e.huffmanTableAC),h=15&o,u=o>>4;if(0!==h){var l=t[r+=u];e.blockData[n+l]=y(h)*(1<<c),r++}else{if(u<15){T=b(u)+(1<<u)-1;break}r+=16}}}:function(e,n){for(var r=a,i=s,o=0;r<=i;){var h=t[r];switch(D){case 0:var u=w(e.huffmanTableAC),l=15&u;if(o=u>>4,0===l)o<15?(T=b(o)+(1<<o),D=4):(o=16,D=1);else{if(1!==l)throw"invalid ACn encoding";x=y(l),D=o?2:3}continue;case 1:case 2:e.blockData[n+h]?e.blockData[n+h]+=m()<<c:0==--o&&(D=2==D?3:0);break;case 3:e.blockData[n+h]?e.blockData[n+h]+=m()<<c:(e.blockData[n+h]=x<<c,D=0);break;case 4:e.blockData[n+h]&&(e.blockData[n+h]+=m()<<c)}r++}4===D&&0==--T&&(D=0)}:function(e,n){var r=w(e.huffmanTableDC),i=0===r?0:y(r);e.blockData[n]=e.pred+=i;for(var o=1;o<64;){var a=w(e.huffmanTableAC),s=15&a,h=a>>4;if(0!==s){var c=t[o+=h];e.blockData[n+c]=y(s),o++}else{if(h<15)break;o+=16}}};var O,k,R,N,B=0;for(k=1==L?i[0].blocksPerLine*i[0].blocksPerColumn:u*r.mcusPerColumn,o||(o=k);B<k;){for(A=0;A<L;A++)i[A].pred=0;if(T=0,1==L)for(C=i[0],I=0;I<o;I++)_(C,P,B),B++;else for(I=0;I<o;I++){for(A=0;A<L;A++)for(R=(C=i[A]).h,N=C.v,E=0;E<N;E++)for(S=0;S<R;S++)v(C,P,B,E,S);B++}if(g=0,(O=e[n]<<8|e[n+1])<=65280)throw"marker was not found";if(!(O>=65488&&O<=65495))break;n+=2}return n-f}function f(t,c,u){var l,d,f,p,g,m,w,b,y,T,x=t.quantizationTable;for(T=0;T<64;T++)u[T]=t.blockData[c+T]*x[T];for(T=0;T<8;++T){var D=8*T;0!==u[1+D]||0!==u[2+D]||0!==u[3+D]||0!==u[4+D]||0!==u[5+D]||0!==u[6+D]||0!==u[7+D]?(l=s*u[0+D]+128>>8,d=s*u[4+D]+128>>8,f=u[2+D],p=u[6+D],g=h*(u[1+D]-u[7+D])+128>>8,b=h*(u[1+D]+u[7+D])+128>>8,m=u[3+D]<<4,w=u[5+D]<<4,y=l-d+1>>1,l=l+d+1>>1,d=y,y=f*a+p*o+128>>8,f=f*o-p*a+128>>8,p=y,y=g-w+1>>1,g=g+w+1>>1,w=y,y=b+m+1>>1,m=b-m+1>>1,b=y,y=l-p+1>>1,l=l+p+1>>1,p=y,y=d-f+1>>1,d=d+f+1>>1,f=y,y=g*i+b*r+2048>>12,g=g*r-b*i+2048>>12,b=y,y=m*n+w*e+2048>>12,m=m*e-w*n+2048>>12,w=y,u[0+D]=l+b,u[7+D]=l-b,u[1+D]=d+w,u[6+D]=d-w,u[2+D]=f+m,u[5+D]=f-m,u[3+D]=p+g,u[4+D]=p-g):(y=s*u[0+D]+512>>10,u[0+D]=y,u[1+D]=y,u[2+D]=y,u[3+D]=y,u[4+D]=y,u[5+D]=y,u[6+D]=y,u[7+D]=y)}for(T=0;T<8;++T){var v=T;0!==u[8+v]||0!==u[16+v]||0!==u[24+v]||0!==u[32+v]||0!==u[40+v]||0!==u[48+v]||0!==u[56+v]?(l=s*u[0+v]+2048>>12,d=s*u[32+v]+2048>>12,f=u[16+v],p=u[48+v],g=h*(u[8+v]-u[56+v])+2048>>12,b=h*(u[8+v]+u[56+v])+2048>>12,m=u[24+v],w=u[40+v],y=l-d+1>>1,l=l+d+1>>1,d=y,y=f*a+p*o+2048>>12,f=f*o-p*a+2048>>12,p=y,y=g-w+1>>1,g=g+w+1>>1,w=y,y=b+m+1>>1,m=b-m+1>>1,b=y,y=l-p+1>>1,l=l+p+1>>1,p=y,y=d-f+1>>1,d=d+f+1>>1,f=y,y=g*i+b*r+2048>>12,g=g*r-b*i+2048>>12,b=y,y=m*n+w*e+2048>>12,m=m*e-w*n+2048>>12,w=y,u[0+v]=l+b,u[56+v]=l-b,u[8+v]=d+w,u[48+v]=d-w,u[16+v]=f+m,u[40+v]=f-m,u[24+v]=p+g,u[32+v]=p-g):(y=s*u[T+0]+8192>>14,u[0+v]=y,u[8+v]=y,u[16+v]=y,u[24+v]=y,u[32+v]=y,u[40+v]=y,u[48+v]=y,u[56+v]=y)}for(T=0;T<64;++T){var _=c+T,C=u[T];C=C<=-2056/t.bitConversion?0:C>=2024/t.bitConversion?255/t.bitConversion:C+2056/t.bitConversion>>4,t.blockData[_]=C}}function p(t,e){for(var n=e.blocksPerLine,r=e.blocksPerColumn,i=new Int32Array(64),o=0;o<r;o++)for(var a=0;a<n;a++){f(e,l(e,o,a),i)}return e.blockData}function g(t){return t<=0?0:t>=255?255:0|t}return c.prototype={load:function(t){var e=function(t){this.parse(t),this.onload&&this.onload()}.bind(this);if(t.indexOf("data:")>-1){for(var n=t.indexOf("base64,")+7,r=atob(t.substring(n)),i=new Uint8Array(r.length),o=r.length-1;o>=0;o--)i[o]=r.charCodeAt(o);e(r)}else{var a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType="arraybuffer",a.onload=function(){var t=new Uint8Array(a.response);e(t)}.bind(this),a.send(null)}},parse:function(e){function n(){var t=e[s]<<8|e[s+1];return s+=2,t}function r(){var t=n(),r=e.subarray(s,s+t-2);return s+=r.length,r}function i(t){for(var e=Math.ceil(t.samplesPerLine/8/t.maxH),n=Math.ceil(t.scanLines/8/t.maxV),r=0;r<t.components.length;r++){q=t.components[r];var i=Math.ceil(Math.ceil(t.samplesPerLine/8)*q.h/t.maxH),o=Math.ceil(Math.ceil(t.scanLines/8)*q.v/t.maxV),a=e*q.h,s=64*(n*q.v)*(a+1);q.blockData=new Int16Array(s),q.blocksPerLine=i,q.blocksPerColumn=o}t.mcusPerLine=e,t.mcusPerColumn=n}var o,a,s=0,h=(e.length,null),c=null,l=[],f=[],g=[],m=n();if(65496!=m)throw"SOI not found";for(m=n();65497!=m;){var w,b;switch(m){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var y=r();65504===m&&74===y[0]&&70===y[1]&&73===y[2]&&70===y[3]&&0===y[4]&&(h={version:{major:y[5],minor:y[6]},densityUnits:y[7],xDensity:y[8]<<8|y[9],yDensity:y[10]<<8|y[11],thumbWidth:y[12],thumbHeight:y[13],thumbData:y.subarray(14,14+3*y[12]*y[13])}),65518===m&&65===y[0]&&100===y[1]&&111===y[2]&&98===y[3]&&101===y[4]&&0===y[5]&&(c={version:y[6],flags0:y[7]<<8|y[8],flags1:y[9]<<8|y[10],transformCode:y[11]});break;case 65499:for(var T=n()+s-2;s<T;){var x=e[s++],D=new Int32Array(64);if(x>>4==0)for(w=0;w<64;w++){D[t[w]]=e[s++]}else{if(x>>4!=1)throw"DQT: invalid table spec";for(w=0;w<64;w++){D[t[w]]=n()}}l[15&x]=D}break;case 65472:case 65473:case 65474:if(o)throw"Only single frame JPEGs supported";n(),(o={}).extended=65473===m,o.progressive=65474===m,o.precision=e[s++],o.scanLines=n(),o.samplesPerLine=n(),o.components=[],o.componentIds={};var v,_=e[s++],C=0,A=0;for(j=0;j<_;j++){v=e[s];var E=e[s+1]>>4,S=15&e[s+1];C<E&&(C=E),A<S&&(A=S);var I=e[s+2];b=o.components.push({h:E,v:S,quantizationTable:l[I],quantizationTableId:I,bitConversion:255/((1<<o.precision)-1)}),o.componentIds[v]=b-1,s+=3}o.maxH=C,o.maxV=A,i(o);break;case 65476:var P=n();for(j=2;j<P;){var O=e[s++],k=new Uint8Array(16),R=0;for(w=0;w<16;w++,s++)R+=k[w]=e[s];var N=new Uint8Array(R);for(w=0;w<R;w++,s++)N[w]=e[s];j+=17+R,(O>>4==0?g:f)[15&O]=u(k,N)}break;case 65501:n(),a=n();break;case 65498:n();var B=e[s++],F=[];for(j=0;j<B;j++){var U=o.componentIds[e[s++]];q=o.components[U];var X=e[s++];q.huffmanTableDC=g[X>>4],q.huffmanTableAC=f[15&X],F.push(q)}var M=e[s++],z=e[s++],V=e[s++],G=d(e,s,o,F,a,M,z,V>>4,15&V);s+=G;break;case 65535:255!==e[s]&&s--;break;default:if(255==e[s-3]&&e[s-2]>=192&&e[s-2]<=254){s-=3;break}throw"unknown JPEG marker "+m.toString(16)}m=n()}switch(this.width=o.samplesPerLine,this.height=o.scanLines,this.jfif=h,this.adobe=c,this.components=[],o.components.length){case 1:this.colorspace=L.Grayscale;break;case 3:this.adobe?this.colorspace=L.AdobeRGB:this.colorspace=L.RGB;break;case 4:this.colorspace=L.CYMK;break;default:this.colorspace=L.Unknown}for(var j=0;j<o.components.length;j++){var q;(q=o.components[j]).quantizationTable||null===q.quantizationTableId||(q.quantizationTable=l[q.quantizationTableId]),this.components.push({output:p(0,q),scaleX:q.h/o.maxH,scaleY:q.v/o.maxV,blocksPerLine:q.blocksPerLine,blocksPerColumn:q.blocksPerColumn,bitConversion:q.bitConversion})}},getData16:function(t,e){if(1!==this.components.length)throw"Unsupported color mode";var n,r,i,o,a,s,h=this.width/t,c=this.height/e,u=0,d=this.components.length,f=new Uint16Array(t*e*d),p=new Uint16Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8);for(s=0;s<d;s++){for(var g,m,w,b=(n=this.components[s]).blocksPerLine,y=n.blocksPerColumn,T=b<<3,x=0,D=0;D<y;D++)for(var v=D<<3,_=0;_<b;_++){var C=l(n,D,_),A=(u=0,_<<3);for(g=0;g<8;g++){x=(v+g)*T;for(m=0;m<8;m++)p[x+A+m]=n.output[C+u++]}}for(r=n.scaleX*h,i=n.scaleY*c,u=s,a=0;a<e;a++)for(o=0;o<t;o++)w=(0|a*i)*T+(0|o*r),f[u]=p[w],u+=d}return f},getData:function(t,e){var n,r,i,o,a,s,h,c,u,d,f,p,m,w,b,y=this.width/t,T=this.height/e,x=0,D=this.components.length,v=t*e*D,_=new Uint8Array(v),C=new Uint8Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8);for(s=0;s<D;s++){for(var A,E,S,I=(n=this.components[s]).blocksPerLine,P=n.blocksPerColumn,L=I<<3,O=0,k=0;k<P;k++)for(var R=k<<3,N=0;N<I;N++){var B=l(n,k,N),F=(x=0,N<<3);for(A=0;A<8;A++){O=(R+A)*L;for(E=0;E<8;E++)C[O+F+E]=n.output[B+x++]*n.bitConversion}}for(r=n.scaleX*y,i=n.scaleY*T,x=s,a=0;a<e;a++)for(o=0;o<t;o++)S=(0|a*i)*L+(0|o*r),_[x]=C[S],x+=D}switch(D){case 1:case 2:break;case 3:if(b=!0,this.adobe&&this.adobe.transformCode?b=!0:void 0!==this.colorTransform&&(b=!!this.colorTransform),b)for(s=0;s<v;s+=D)h=_[s],c=_[s+1],p=g(h-179.456+1.402*(u=_[s+2])),m=g(h+135.459-.344*c-.714*u),w=g(h-226.816+1.772*c),_[s]=p,_[s+1]=m,_[s+2]=w;break;case 4:if(!this.adobe)throw"Unsupported color mode (4 components)";if(b=!1,this.adobe&&this.adobe.transformCode?b=!0:void 0!==this.colorTransform&&(b=!!this.colorTransform),b)for(s=0;s<v;s+=D)h=_[s],c=_[s+1],d=g(434.456-h-1.402*(u=_[s+2])),f=g(119.541-h+.344*c+.714*u),h=g(481.816-h-1.772*c),_[s]=d,_[s+1]=f,_[s+2]=h;break;default:throw"Unsupported color mode"}return _}},c}();var k=void 0,R=void 0;function N(){this.dicom={dicom:!1}}N.prototype={parse:function(t){try{for(var e=new Uint8Array(t.length),n=0,r=t.length;n<r;++n)e[n]=t.charCodeAt(n);this.dataSet=dicomParser.parseDicom(e),this.dicom.dicom=!0}catch(t){return console.error(t),this.dicom.dicom=!1,this.dicom}return this.getPhotometricInterpretation(),this.getComponents(),this.getWidth(),this.getHeight(),this.getDepth(),this.getBitsAllocated(),this.getBitsStored(),this.getPixelRepresentation(),this.getPlanarConfiguration(),this.getTansferSyntax(),this.getPixelData(),this.dicom},getPhotometricInterpretation:function(){this.photometricInterpretation=this.dataSet.string("x00280004")},getComponents:function(){this.dicom.components=this.dataSet.uint16("x00280002")},getWidth:function(){this.dicom.width=this.dataSet.uint16("x00280011")},getHeight:function(){this.dicom.height=this.dataSet.uint16("x00280010")},getDepth:function(){this.dataSet.elements.x00280008?this.dicom.depth=this.dataSet.intString("x00280008"):this.dicom.depth=1},getBitsAllocated:function(){this.bitsAllocated=this.dataSet.uint16("x00280100")},getBitsStored:function(){this.bitsStored=this.dataSet.uint16("x00280101")},getPixelRepresentation:function(){this.pixelRepresentation=this.dataSet.uint16("x00280103")||0},getPlanarConfiguration:function(){this.planarConfiguration=this.dataSet.uint16("x00280006")||0},getTansferSyntax:function(){this.transferSyntax=this.dataSet.string("x00020010")},getPixelData:function(){var t=this.dicom,e=this.dataSet.elements.x7fe00010||this.dataSet.elements.x7fe00008,n="PALETTE COLOR"===this.photometricInterpretation?3:this.dicom.components,r=t.width*t.height*n,i=r*t.depth,o=new Uint8Array(i);if(this.getFrames(e).forEach((function(t,e){switch(this.transferSyntax){case"1.2.840.10008.1.2":case"1.2.840.10008.1.2.1":case"1.2.840.10008.1.2.1.99":t=this.decodeLittleEndian(t);break;case"1.2.840.10008.1.2.2":t=this.decodeBigEndian(t);break;case"1.2.840.10008.1.2.5":t=this.decodeRLE(t);break;case"1.2.840.10008.1.2.4.50":case"1.2.840.10008.1.2.4.51":t=this.decodeJPEGBaseline(t);break;case"1.2.840.10008.1.2.4.57":case"1.2.840.10008.1.2.4.70":t=this.decodeJPEGLossless(t);break;case"1.2.840.10008.1.2.4.80":case"1.2.840.10008.1.2.4.81":t=this.decodeJPEGLS(t);break;case"1.2.840.10008.1.2.4.90":case"1.2.840.10008.1.2.4.91":t=this.decodeJPEG2000(t);break;case"1.2.840.10008.1.2.4.52":case"1.2.840.10008.1.2.4.53":case"1.2.840.10008.1.2.4.54":case"1.2.840.10008.1.2.4.55":case"1.2.840.10008.1.2.4.56":case"1.2.840.10008.1.2.4.58":case"1.2.840.10008.1.2.4.59":case"1.2.840.10008.1.2.4.60":case"1.2.840.10008.1.2.4.61":case"1.2.840.10008.1.2.4.62":case"1.2.840.10008.1.2.4.63":case"1.2.840.10008.1.2.4.64":case"1.2.840.10008.1.2.4.65":case"1.2.840.10008.1.2.4.66":case"1.2.840.10008.1.2.4.92":case"1.2.840.10008.1.2.4.93":throw new Error("DICOM: this JPEG encoding ("+this.transferSyntax+") is not supported.");default:throw new Error("DICOM: unsupported transfer syntax '"+this.transferSyntax+"'.")}if(t=this.getTypedArray(t),1===this.pixelRepresentation&&void 0!==this.bitsStored)for(var i=32-this.bitsStored,a=0,s=t.length;a<s;++a)t[a]=t[a]<<i>>i;switch(this.photometricInterpretation){case"MONOCHROME1":case"MONOCHROME2":break;case"RGB":case"YBR_RCT":case"YBR_ICT":case"YBR_FULL_422":1===this.planarConfiguration&&(t=this.convertRGBColorByPlane(t));break;case"YBR_FULL":t=0===this.planarConfiguration?this.convertYBRFullByPixel(t):this.convertYBRFullByPlane(t);break;case"PALETTE COLOR":t=this.convertPaletteColor(t);break;default:throw new Error("DICOM: unsupported image type '"+this.photometricInterpretation+"'.")}t=this.flipImage(t,n);var h=this.getNormalizeOffsetAndFactor(t),c=e*r;for(a=0,s=t.length;a<s;++a,++c)o[c]=(t[a]-h.offset)*h.factor}),this),"MONOCHROME1"===this.photometricInterpretation)for(var a=0,s=o.length;a<s;++a)o[a]=255-o[a];t.components=n,t.data=o},getFrames:function(t){var e=[];if(t.encapsulatedPixelData)if(t.basicOffsetTable.length)for(var n=0,r=this.dicom.depth;n<r;++n)e.push(dicomParser.readEncapsulatedImageFrame(this.dataSet,t,n));else if(this.dicom.depth!==t.fragments.length){var i=dicomParser.createJPEGBasicOffsetTable(this.dataSet,t);for(n=0,r=this.dicom.depth;n<r;++n)e.push(dicomParser.readEncapsulatedImageFrame(this.dataSet,t,n,i))}else for(n=0,r=this.dicom.depth;n<r;++n)e.push(dicomParser.readEncapsulatedPixelDataFromFragments(this.dataSet,t,n));else{var o=this.dicom.width*this.dicom.height*this.dicom.components;switch(this.bitsAllocated){case 1:for(n=0,r=this.dicom.depth;n<r;++n){var a=t.dataOffset+n*o/8;e.push(this.unpackBinaryFrame(this.dataSet.byteArray,a,o))}this.bitsAllocated=8;break;case 8:case 16:case 32:var s=this.bitsAllocated/8;for(n=0,r=this.dicom.depth;n<r;++n){a=t.dataOffset+n*o*s;e.push(new Uint8Array(this.dataSet.byteArray.buffer,a,o*s))}break;default:throw new Error("DICOM: unsupported pixel format.")}}return e},getTypedArray:function(t){switch(this.bitsAllocated){case 8:return new(this.pixelRepresentation?Int8Array:Uint8Array)(t.buffer,t.byteOffset,t.length);case 16:return new(this.pixelRepresentation?Int16Array:Uint16Array)(t.buffer,t.byteOffset,t.length/2);case 32:return new Float32Array(t.buffer,t.byteOffset,t.length/4);default:throw new Error("DICOM: unsupported pixel format.")}},flipImage:function(t,e){for(var n=this.dicom.width,r=this.dicom.height,i=new t.constructor(t.length),o=0;o<r;++o)for(var a=e*n*(r-1-o),s=e*n*o,h=0,c=e*n;h<c;++h)i[s+h]=t[a+h];return i},getNormalizeOffsetAndFactor:function(t){for(var e=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,r=0,i=t.length;r<i;++r)e=Math.min(e,t[r]),n=Math.max(n,t[r]);var o=n-e;return{offset:e,factor:o?1/o*255:0}},unpackBinaryFrame:function(t,e,n){function r(t,e){return t&1<<e}for(var i=new Uint8Array(n),o=0;o<n;++o){var a=t[Math.floor(o/8)+e],s=o%8;i[o]=r(a,s)?1:0}return i},decodeLittleEndian:function(t){var e=t.buffer,n=t.byteOffset,r=t.length;return 16===this.bitsAllocated?(n%2&&(e=e.slice(n),n=0),new Uint8Array(e,n,r)):32===this.bitsAllocated?(n%4&&(e=e.slice(n),n=0),new Uint8Array(e,n,r)):t},decodeBigEndian:function(t){if(16===this.bitsAllocated){var e=t.buffer,n=t.byteOffset,r=t.length;n%2&&(e=e.slice(n),n=0);for(var i=0,o=(t=new Uint16Array(e,n,r/2)).length;i<o;++i)t[i]=(255&(a=t[i]))<<8|a>>8&255;return new Uint8Array(e,n,r)}var a;return t},decodeRLE:function(t){if(8===this.bitsAllocated)return this.planarConfiguration?this.decodeRLE8Planar(t):this.decodeRLE8(t);if(16===this.bitsAllocated)return this.decodeRLE16(t);throw new Error("DICOM: unsupported pixel format for RLE.")},decodeRLE8:function(t){const e=t,n=this.dicom.width*this.dicom.height,r=this.dicom.components,i=new ArrayBuffer(n*this.dicom.components),o=new DataView(e.buffer,e.byteOffset),a=new Int8Array(e.buffer,e.byteOffset),s=new Int8Array(i);let h=0;const c=o.getInt32(0,!0);for(let t=0;t<c;++t){h=t;let i=o.getInt32(4*(t+1),!0),u=o.getInt32(4*(t+2),!0);0===u&&(u=e.length);const l=n*c;for(;i<u;){const t=a[i++];if(t>=0&&t<=127)for(let e=0;e<t+1&&h<l;++e)s[h]=a[i++],h+=r;else if(t<=-1&&t>=-127){const e=a[i++];for(let n=0;n<1-t&&h<l;++n)s[h]=e,h+=r}}}return s},decodeRLE8Planar:function(t){const e=t,n=this.dicom.width*this.dicom.height,r=new ArrayBuffer(n*this.dicom.components),i=new DataView(e.buffer,e.byteOffset),o=new Int8Array(e.buffer,e.byteOffset),a=new Int8Array(r);let s=0;const h=i.getInt32(0,!0);for(let t=0;t<h;++t){s=t*n;let r=i.getInt32(4*(t+1),!0),c=i.getInt32(4*(t+2),!0);0===c&&(c=e.length);const u=n*h;for(;r<c;){const t=o[r++];if(t>=0&&t<=127)for(let e=0;e<t+1&&s<u;++e)a[s]=o[r++],++s;else if(t<=-1&&t>=-127){const e=o[r++];for(let n=0;n<1-t&&s<u;++n)a[s]=e,++s}}}return a},decodeRLE16:function(t){const e=t,n=this.dicom.width*this.dicom.height,r=new ArrayBuffer(n*this.dicom.components*2),i=new DataView(e.buffer,e.byteOffset),o=new Int8Array(e.buffer,e.byteOffset),a=new Int8Array(r),s=i.getInt32(0,!0);for(let t=0;t<s;++t){let r=0;const s=0===t?1:0;let h=i.getInt32(4*(t+1),!0),c=i.getInt32(4*(t+2),!0);for(0===c&&(c=e.length);h<c;){const t=o[h++];if(t>=0&&t<=127)for(let e=0;e<t+1&&r<n;++e)a[2*r+s]=o[h++],++r;else if(t<=-1&&t>=-127){const e=o[h++];for(let i=0;i<1-t&&r<n;++i)a[2*r+s]=e,++r}}}return a},decodeJPEGBaseline:function(t){var e=new O;e.parse(t),e.colorTransform=!0;var n=e.getData(this.dicom.width,this.dicom.height);return this.bitsAllocated=8,n},decodeJPEGLossless:function(t){var e=(new jpegLossless.lossless.Decoder).decompress(t);return new Uint8Array(e)},decodeJPEGLS:function(t){var e=this.jpegLSDecode(t,1===this.pixelRepresentation);if(0!==e.result&&6!==e.result)throw new Error(`DICOM: JPEG-LS decoder failed to decode frame (error code ${e.result}).`);return new Uint8Array(e.pixelData.buffer)},jpegLSDecode:function(t,e){const n=(k=k||CharLS())._malloc(t.length);k.writeArrayToMemory(t,n);const r=k._malloc(4),i=k._malloc(4),o=k._malloc(4),a=k._malloc(4),s=k._malloc(4),h=k._malloc(4),c=k._malloc(4),u=k._malloc(4),l=k._malloc(4),d={result:k.ccall("jpegls_decode","number",["number","number","number","number","number","number","number","number","number","number","number"],[n,t.length,r,i,o,a,s,h,u,c,l]),width:k.getValue(o,"i32"),height:k.getValue(a,"i32"),bitsPerSample:k.getValue(s,"i32"),stride:k.getValue(h,"i32"),components:k.getValue(u,"i32"),allowedLossyError:k.getValue(c,"i32"),interleaveMode:k.getValue(l,"i32"),pixelData:void 0},f=k.getValue(r,"*");return d.bitsPerSample<=8?(d.pixelData=new Uint8Array(d.width*d.height*d.components),d.pixelData.set(new Uint8Array(k.HEAP8.buffer,f,d.pixelData.length))):e?(d.pixelData=new Int16Array(d.width*d.height*d.components),d.pixelData.set(new Int16Array(k.HEAP16.buffer,f,d.pixelData.length))):(d.pixelData=new Uint16Array(d.width*d.height*d.components),d.pixelData.set(new Uint16Array(k.HEAP16.buffer,f,d.pixelData.length))),k._free(n),k._free(f),k._free(r),k._free(i),k._free(o),k._free(a),k._free(s),k._free(h),k._free(u),k._free(l),d},decodeJPEG2000:function(t){var e=this.bitsAllocated<=8?1:2,n=1===this.pixelRepresentation,r=this.decodeOpenJPEG(t,e,n);return r.nbChannels>1&&(this.photometricInterpretation="RGB"),new Uint8Array(r.pixelData.buffer)},decodeOpenJPEG:function(t,e,n){const r=(R=R||OpenJPEG())._malloc(t.length);R.writeArrayToMemory(t,r);const i=R._malloc(4),o=R._malloc(4),a=R._malloc(4),s=R._malloc(4),h=R._malloc(4),c=(new Date).getTime();if(0!==R.ccall("jp2_decode","number",["number","number","number","number","number","number","number"],[r,t.length,i,o,a,s,h]))return console.log("[opj_decode] decoding failed!"),R._free(r),R._free(R.getValue(i,"*")),R._free(a),R._free(s),R._free(o),void R._free(h);const u=R.getValue(i,"*"),l={length:R.getValue(o,"i32"),sx:R.getValue(a,"i32"),sy:R.getValue(s,"i32"),nbChannels:R.getValue(h,"i32"),perf_timetodecode:void 0,pixelData:void 0},d=l.sx*l.sy*l.nbChannels,f=new Int32Array(R.HEAP32.buffer,u,d);if(1===e)if(Uint8Array.from)l.pixelData=Uint8Array.from(f);else{l.pixelData=new Uint8Array(d);for(let t=0;t<d;t++)l.pixelData[t]=f[t]}else if(n)if(Int16Array.from)l.pixelData=Int16Array.from(f);else{l.pixelData=new Int16Array(d);for(let t=0;t<d;t++)l.pixelData[t]=f[t]}else if(Uint16Array.from)l.pixelData=Uint16Array.from(f);else{l.pixelData=new Uint16Array(d);for(let t=0;t<d;t++)l.pixelData[t]=f[t]}const p=(new Date).getTime();return l.perf_timetodecode=p-c,R._free(r),R._free(i),R._free(u),R._free(o),R._free(a),R._free(s),R._free(h),l},convertRGBColorByPlane:function(t){if(t.length%3!=0)throw new Error("DICOM: convertRGBColorByPlane: RGB buffer length must be divisble by 3.");for(var e=t.length/3,n=0,r=0,i=e,o=2*e,a=new t.constructor(t.length),s=0;s<e;++s)a[n++]=t[r++],a[n++]=t[i++],a[n++]=t[o++];return a},convertYBRFullByPixel:function(t){if(t.length%3!=0)throw new Error("DICOM: convertYBRFullByPixel: YBR buffer length must be divisble by 3.");console.log(t);for(var e=t.length/3,n=0,r=0,i=new t.constructor(t.length),o=0;o<e;++o){var a=t[n++],s=t[n++],h=t[n++];i[r++]=a+1.402*(h-128),i[r++]=a-.34414*(s-128)-.71414*(h-128),i[r++]=a+1.772*(s-128)}return i},convertYBRFullByPlane:function(t){if(t.length%3!=0)throw new Error("DICOM: convertYBRFullByPlane: YBR buffer length must be divisble by 3.");for(var e=t.length/3,n=0,r=0,i=e,o=2*e,a=new t.constructor(t.length),s=0;s<e;++s){var h=t[r++],c=t[i++],u=t[o++];a[n++]=h+1.402*(u-128),a[n++]=h-.34414*(c-128)-.71414*(u-128),a[n++]=h+1.772*(c-128)}return a},convertPaletteColor:function(t){function e(t,e){if(t.cleaned)return t.cleaned;const n=t.length,r=new Uint8ClampedArray(n);for(let i=0;i<n;++i)r[i]=t[i]>>e;return t.cleaned=r,r}const n=this.getLUT(),r=this.dicom.width*this.dicom.height,i=n.redPaletteColorLookupTableData,o=n.greenPaletteColorLookupTableData,a=n.bluePaletteColorLookupTableData,s=n.redPaletteColorLookupTableData.length;let h=0,c=0;const u=n.redPaletteColorLookupTableDescriptor[1],l=8===n.redPaletteColorLookupTableDescriptor[2]?0:8,d=e(i,l),f=e(o,l),p=e(a,l);let g=new Uint8Array(3*t.length);for(let e=0;e<r;++e){let e=t[h++];e<u?e=0:e>u+s-1?e=s-1:e-=u,g[c++]=d[e],g[c++]=f[e],g[c++]=p[e]}return g},getLUT:function(){return this.LUT||(this.LUT={},this.populatePaletteColorLut(this.dataSet,this.LUT)),this.LUT},populatePaletteColorLut:function(t,e){e.redPaletteColorLookupTableDescriptor=this.getLutDescriptor(t,"x00281101"),e.greenPaletteColorLookupTableDescriptor=this.getLutDescriptor(t,"x00281102"),e.bluePaletteColorLookupTableDescriptor=this.getLutDescriptor(t,"x00281103"),0===e.redPaletteColorLookupTableDescriptor[0]&&(e.redPaletteColorLookupTableDescriptor[0]=65536,e.greenPaletteColorLookupTableDescriptor[0]=65536,e.bluePaletteColorLookupTableDescriptor[0]=65536);const n=e.redPaletteColorLookupTableDescriptor[0],r=t.elements.x00281201.length===n?8:16;e.redPaletteColorLookupTableDescriptor[2]!==r&&(e.redPaletteColorLookupTableDescriptor[2]=r,e.greenPaletteColorLookupTableDescriptor[2]=r,e.bluePaletteColorLookupTableDescriptor[2]=r),e.redPaletteColorLookupTableData=this.getLutData(t,"x00281201",e.redPaletteColorLookupTableDescriptor),e.greenPaletteColorLookupTableData=this.getLutData(t,"x00281202",e.greenPaletteColorLookupTableDescriptor),e.bluePaletteColorLookupTableData=this.getLutData(t,"x00281203",e.bluePaletteColorLookupTableDescriptor)},getLutDescriptor:function(t,e){if(t.elements[e]&&6===t.elements[e].length)return[t.uint16(e,0),t.uint16(e,1),t.uint16(e,2)]},getLutData:function(t,e,n){const r=[],i=t.elements[e];for(let o=0;o<n[0];++o)16===n[2]?r[o]=t.uint16(e,o):r[o]=t.byteArray[o+i.dataOffset];return r}};const B=N,F=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/InputOutput/FileLoader");var U=t.n(F);function X(t){g.call(this,t),C().call(this,t),this.addType(d().ImageTexture3D)}X.prototype=Object.assign(Object.create(g.prototype),C().prototype,{constructor:X,[Symbol.for("X_ITE.X3DBaseNode.fieldDefinitions")]:new(h())([new(a())(d().inputOutput,"metadata",new(i().SFNode)),new(a())(d().inputOutput,"description",new(i().SFString)),new(a())(d().inputOutput,"load",new(i().SFBool)(!0)),new(a())(d().inputOutput,"url",new(i().MFString)),new(a())(d().inputOutput,"autoRefresh",new(i().SFTime)),new(a())(d().inputOutput,"autoRefreshTimeLimit",new(i().SFTime)(3600)),new(a())(d().initializeOnly,"repeatS",new(i().SFBool)),new(a())(d().initializeOnly,"repeatT",new(i().SFBool)),new(a())(d().initializeOnly,"repeatR",new(i().SFBool)),new(a())(d().initializeOnly,"textureProperties",new(i().SFNode))]),getTypeName:function(){return"ImageTexture3D"},getComponentName:function(){return"Texturing3D"},getContainerField:function(){return"texture"},initialize:function(){g.prototype.initialize.call(this),C().prototype.initialize.call(this),this.requestImmediateLoad()},getInternalType:function(t){const e=this.getBrowser().getContext();switch(t){case 1:return e.LUMINANCE;case 2:return e.LUMINANCE_ALPHA;case 3:return e.RGB;case 4:return e.RGBA}},unLoadNow:function(){this.clearTexture()},loadNow:function(){new(U())(this).loadBinaryDocument(this._url,function(t){if(null!==t){const e=(new P).parse(t);if(e.nrrd){const t=this.getInternalType(e.components);return this.setTexture(e.width,e.height,e.depth,!1,t,e.data),void this.setLoadState(d().COMPLETE_STATE)}const n=(new B).parse(t);if(n.dicom){const t=this.getInternalType(n.components);return this.setTexture(n.width,n.height,n.depth,!1,t,n.data),void this.setLoadState(d().COMPLETE_STATE)}throw new Error("ImageTexture3D: no appropriate file type handler found.")}this.setLoadState(d().FAILED_STATE),this.clearTexture()}.bind(this))}});const M=X;function z(t){g.call(this,t),this.addType(d().PixelTexture3D),this.addChildObjects("loadState",new(i().SFInt32)(d().NOT_STARTED_STATE))}z.prototype=Object.assign(Object.create(g.prototype),{constructor:z,[Symbol.for("X_ITE.X3DBaseNode.fieldDefinitions")]:new(h())([new(a())(d().inputOutput,"metadata",new(i().SFNode)),new(a())(d().inputOutput,"description",new(i().SFString)),new(a())(d().inputOutput,"image",new(i().MFInt32)(0,0,0,0)),new(a())(d().initializeOnly,"repeatS",new(i().SFBool)),new(a())(d().initializeOnly,"repeatT",new(i().SFBool)),new(a())(d().initializeOnly,"repeatR",new(i().SFBool)),new(a())(d().initializeOnly,"textureProperties",new(i().SFNode))]),getTypeName:function(){return"PixelTexture3D"},getComponentName:function(){return"Texturing3D"},getContainerField:function(){return"texture"},initialize:function(){g.prototype.initialize.call(this),this._image.addInterest("set_image__",this),this.set_image__()},checkLoadState:function(){return this._loadState.getValue()},set_image__:function(){const t=this._image;if(t.length<4)return this.clearTexture(),void(this._loadState=d().FAILED_STATE);const e=this.getBrowser().getContext(),n=t[0],r=t[1],i=t[2],o=t[3],a=!(1&n),s=r*i*o;let h,c;switch(n){case 1:h=new Uint8Array(s),c=e.LUMINANCE;for(let e=4,n=4+s,r=0;e<n;++e)h[r++]=t[e];break;case 2:h=new Uint8Array(2*s),c=e.LUMINANCE_ALPHA;for(let e=4,n=4+s,r=0;e<n;++e){const n=t[e];h[r++]=n>>>8&255,h[r++]=255&n}break;case 3:h=new Uint8Array(3*s),c=e.RGB;for(let e=4,n=4+s,r=0;e<n;++e){const n=t[e];h[r++]=n>>>16&255,h[r++]=n>>>8&255,h[r++]=255&n}break;case 4:h=new Uint8Array(4*s),c=e.RGBA;for(let e=4,n=4+s,r=0;e<n;++e){const n=t[e];h[r++]=n>>>24&255,h[r++]=n>>>16&255,h[r++]=n>>>8&255,h[r++]=255&n}break;default:return this.clearTexture(),void(this._loadState=d().FAILED_STATE)}this.setTexture(r,i,o,a,c,h),this._loadState=d().COMPLETE_STATE}});const V=z,G=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Components/Texturing/X3DSingleTextureCoordinateNode");var j=t.n(G);window[Symbol.for("X_ITE.X3D-7.0.0")].require("standard/Math/Numbers/Vector4");function q(t){j().call(this,t),this.addType(d().TextureCoordinate3D)}q.prototype=Object.assign(Object.create(j().prototype),{constructor:q,[Symbol.for("X_ITE.X3DBaseNode.fieldDefinitions")]:new(h())([new(a())(d().inputOutput,"metadata",new(i().SFNode)),new(a())(d().inputOutput,"mapping",new(i().SFString)),new(a())(d().inputOutput,"point",new(i().MFVec3f))]),getTypeName:function(){return"TextureCoordinate3D"},getComponentName:function(){return"Texturing3D"},getContainerField:function(){return"texCoord"},initialize:function(){j().prototype.initialize.call(this),this._point.addInterest("set_point__",this),this.set_point__()},set_point__:function(){this.point=this._point.getValue(),this.length=this._point.length},isEmpty:function(){return 0===this.length},getSize:function(){return this.length},get1Point:function(t,e){if(t>=0&&t<this.length){const n=this.point;return t*=3,e.set(n[t],n[t+1],n[t+2],1)}if(t>=0&&this.length){const n=this.point;return t%=this.length,t*=3,e.set(n[t],n[t+1],n[t+2],1)}return e.set(0,0,0,1)},addTexCoordToChannel:function(t,e){if(t>=0&&t<this.length){const n=this.point;t*=3,e.push(n[t],n[t+1],n[t+2],1)}else if(t>=0&&this.length){const n=this.point;t%=this.length,t*=3,e.push(n[t],n[t+1],n[t+2],1)}else e.push(0,0,0,1)},getTexCoord:function(t){const e=this.point,n=this.length;for(let r=0,i=0;r<n;++r,i+=3)t.push(e[i],e[i+1],e[i+2],1);return t}});const Y=q;function H(t){j().call(this,t),this.addType(d().TextureCoordinate4D)}H.prototype=Object.assign(Object.create(j().prototype),{constructor:H,[Symbol.for("X_ITE.X3DBaseNode.fieldDefinitions")]:new(h())([new(a())(d().inputOutput,"metadata",new(i().SFNode)),new(a())(d().inputOutput,"mapping",new(i().SFString)),new(a())(d().inputOutput,"point",new(i().MFVec4f))]),getTypeName:function(){return"TextureCoordinate4D"},getComponentName:function(){return"Texturing3D"},getContainerField:function(){return"texCoord"},initialize:function(){j().prototype.initialize.call(this),this._point.addInterest("set_point__",this),this.set_point__()},set_point__:function(){this.point=this._point.getValue(),this.length=this._point.length},isEmpty:function(){return 0===this.length},getSize:function(){return this.length},get1Point:function(t,e){if(t>=0&&t<this.length){const n=this.point;return t*=4,e.set(n[t],n[t+1],n[t+2],n[t+3])}if(t>=0&&this.length){const n=this.point;return t%=this.length,t*=4,e.set(n[t],n[t+1],n[t+2],n[t+3])}return e.set(0,0,0,1)},addTexCoordToChannel:function(t,e){if(t>=0&&t<this.length){const n=this.point;t*=4,e.push(n[t],n[t+1],n[t+2],n[t+3])}else if(t>=0&&this.length){const n=this.point;t%=this.length,t*=4,e.push(n[t],n[t+1],n[t+2],n[t+3])}else e.push(0,0,0,1)},getTexCoord:function(t){const e=this.point,n=this.length;for(let r=0,i=0;r<n;++r,i+=4)t.push(e[i],e[i+1],e[i+2],e[i+3]);return t}});const J=H,W=window[Symbol.for("X_ITE.X3D-7.0.0")].require("x_ite/Components/Texturing/X3DSingleTextureTransformNode");var Z=t.n(W);const K=window[Symbol.for("X_ITE.X3D-7.0.0")].require("standard/Math/Numbers/Vector3");var $=t.n(K);const Q=window[Symbol.for("X_ITE.X3D-7.0.0")].require("standard/Math/Numbers/Rotation4");var tt=t.n(Q);const et=window[Symbol.for("X_ITE.X3D-7.0.0")].require("standard/Math/Numbers/Matrix4");var nt=t.n(et);function rt(t){Z().call(this,t),this.addType(d().TextureTransform3D),this.matrix=new(nt())}rt.prototype=Object.assign(Object.create(Z().prototype),{constructor:rt,[Symbol.for("X_ITE.X3DBaseNode.fieldDefinitions")]:new(h())([new(a())(d().inputOutput,"metadata",new(i().SFNode)),new(a())(d().inputOutput,"mapping",new(i().SFString)),new(a())(d().inputOutput,"translation",new(i().SFVec3f)),new(a())(d().inputOutput,"rotation",new(i().SFRotation)),new(a())(d().inputOutput,"scale",new(i().SFVec3f)(1,1,1)),new(a())(d().inputOutput,"center",new(i().SFVec3f))]),getTypeName:function(){return"TextureTransform3D"},getComponentName:function(){return"Texturing3D"},getContainerField:function(){return"textureTransform"},initialize:function(){Z().prototype.initialize.call(this),this.addInterest("eventsProcessed",this),this.eventsProcessed()},getMatrix:function(){return this.matrix},eventsProcessed:function(){const t=new($())(0,0,0);return function(){const e=this._translation.getValue(),n=this._rotation.getValue(),r=this._scale.getValue(),i=this._center.getValue(),o=this.matrix;o.identity(),i.equals($().Zero)||o.translate(t.assign(i).negate()),r.equals($().One)||o.scale(r),n.equals(tt().Identity)||o.rotate(n),i.equals($().Zero)||o.translate(i),e.equals($().Zero)||o.translate(e),this.setMatrix(o)}}()});const it=rt;function ot(t){Z().call(this,t),this.addType(d().TextureTransformMatrix3D)}ot.prototype=Object.assign(Object.create(Z().prototype),{constructor:ot,[Symbol.for("X_ITE.X3DBaseNode.fieldDefinitions")]:new(h())([new(a())(d().inputOutput,"metadata",new(i().SFNode)),new(a())(d().inputOutput,"mapping",new(i().SFString)),new(a())(d().inputOutput,"matrix",new(i().SFMatrix4f))]),getTypeName:function(){return"TextureTransformMatrix3D"},getComponentName:function(){return"Texturing3D"},getContainerField:function(){return"textureTransform"},initialize:function(){Z().prototype.initialize.call(this),this.addInterest("eventsProcessed",this),this.eventsProcessed()},getMatrix:function(){return this._matrix.getValue()},eventsProcessed:function(){this.setMatrix(this._matrix.getValue())}});const at=ot;n().addComponent({name:"Texturing3D",types:{ComposedTexture3D:y,ImageTexture3D:M,PixelTexture3D:V,TextureCoordinate3D:Y,TextureCoordinate4D:J,TextureTransform3D:it,TextureTransformMatrix3D:at},abstractTypes:{X3DTexture3DNode:g}})})();