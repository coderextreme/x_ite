!function(){var t=X3D.define;X3D.require;t("x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode",["x_ite/Components/Texturing/X3DTextureNode","x_ite/Bits/X3DConstants"],function(t,e){"use strict";function i(i){t.call(this,i),this.addType(e.X3DEnvironmentTextureNode)}return i.prototype=Object.assign(Object.create(t.prototype),{constructor:i,initialize:function(){t.prototype.initialize.call(this);var e=this.getBrowser().getContext();this.target=e.TEXTURE_CUBE_MAP,this.targets=[e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y]},set_live__:function(){this.isLive().getValue()?(this.getBrowser().getBrowserOptions().TextureQuality_.addInterest("set_textureQuality__",this),this.set_textureQuality__()):this.getBrowser().getBrowserOptions().TextureQuality_.removeInterest("set_textureQuality__",this)},set_textureQuality__:function(){var t=this.getBrowser().getDefaultTextureProperties();this.updateTextureProperties(this.target,!1,t,128,128,!1,!1,!1)},getTarget:function(){return this.target},getTargets:function(){return this.targets},clearTexture:function(){var t=new Uint8Array([255,255,255,255]);return function(){var e=this.getBrowser().getContext(),i=this.getTargets();e.bindTexture(this.getTarget(),this.getTexture());for(var r=0,n=i.length;r<n;++r)e.texImage2D(i[r],0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,t)}}(),setShaderUniformsToChannel:function(t,e,i,r){t.activeTexture(t.TEXTURE0+e.getBrowser().getCubeMapTextureUnits()[r]),t.bindTexture(t.TEXTURE_CUBE_MAP,this.getTexture()),t.uniform1i(e.x3d_TextureType[r],4)}}),i}),t("x_ite/Components/CubeMapTexturing/ComposedCubeMapTexture",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode","x_ite/Bits/X3DCast","x_ite/Bits/X3DConstants"],function(t,e,i,r,n,s){"use strict";function a(t){r.call(this,t),this.addType(s.ComposedCubeMapTexture),this.addAlias("front",this.frontTexture_),this.addAlias("back",this.backTexture_),this.addAlias("left",this.leftTexture_),this.addAlias("right",this.rightTexture_),this.addAlias("bottom",this.bottomTexture_),this.addAlias("top",this.topTexture_),this.textures=[null,null,null,null,null,null],this.loadStates=0}return a.prototype=Object.assign(Object.create(r.prototype),{constructor:a,fieldDefinitions:new i([new e(s.inputOutput,"metadata",new t.SFNode),new e(s.inputOutput,"frontTexture",new t.SFNode),new e(s.inputOutput,"backTexture",new t.SFNode),new e(s.inputOutput,"leftTexture",new t.SFNode),new e(s.inputOutput,"rightTexture",new t.SFNode),new e(s.inputOutput,"bottomTexture",new t.SFNode),new e(s.inputOutput,"topTexture",new t.SFNode)]),getTypeName:function(){return"ComposedCubeMapTexture"},getComponentName:function(){return"CubeMapTexturing"},getContainerField:function(){return"texture"},initialize:function(){r.prototype.initialize.call(this),this.clearTexture(),this.isLive().addInterest("set_live__",this),this.frontTexture_.addInterest("set_texture__",this,0),this.backTexture_.addInterest("set_texture__",this,1),this.leftTexture_.addInterest("set_texture__",this,2),this.rightTexture_.addInterest("set_texture__",this,3),this.topTexture_.addInterest("set_texture__",this,5),this.bottomTexture_.addInterest("set_texture__",this,4),this.set_texture__(this.frontTexture_,0),this.set_texture__(this.backTexture_,1),this.set_texture__(this.leftTexture_,2),this.set_texture__(this.rightTexture_,3),this.set_texture__(this.topTexture_,4),this.set_texture__(this.bottomTexture_,5),this.set_live__()},set_texture__:function(t,e){var i=this.textures[e];if(i){var r="set_loadState__"+i.getId()+"_"+e;i.removeInterest("set_loadState__",this),i.loadState_.removeFieldCallback(r)}var i=this.textures[e]=n(s.X3DTexture2DNode,t);if(i){var r="set_loadState__"+i.getId()+"_"+e;i.addInterest("set_loadState__",this,i,e),i.loadState_.addFieldCallback(r,this.set_loadState__.bind(this,null,i,e))}this.set_loadState__(null,i,e)},set_loadState__:function(t,e,i){e?this.setLoadStateBit(e.checkLoadState(),e.getData(),i):this.setLoadStateBit(s.NOT_STARTED,null,i),this.setTextures()},setLoadStateBit:function(t,e,i){t===s.COMPLETE_STATE||e?this.loadStates|=1<<i:this.loadStates&=~(1<<i)},isComplete:function(){if(63!==this.loadStates)return!1;for(var t=this.textures,e=t[0].getWidth(),i=0;i<6;++i){var r=t[i];if(r.getWidth()!==e)return!1;if(r.getHeight()!==e)return!1}return!0},setTextures:function(){var t=this.getBrowser().getContext();if(t.bindTexture(this.getTarget(),this.getTexture()),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.isComplete()){for(var e=this.textures,i=0;i<6;++i){var t=this.getBrowser().getContext(),r=e[i],n=r.getWidth(),s=r.getHeight(),a=r.getData();t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!r.getFlipY()),t.pixelStorei(t.UNPACK_ALIGNMENT,1),a instanceof Uint8Array?t.texImage2D(this.getTargets()[i],0,t.RGBA,n,s,!1,t.RGBA,t.UNSIGNED_BYTE,a):t.texImage2D(this.getTargets()[i],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,a)}this.set_textureQuality__()}else this.clearTexture();this.set_transparent__()},set_transparent__:function(){var t=this.textures,e=!1;if(this.isComplete())for(var i=0;i<6;++i)if(t[i].transparent_.getValue()){e=!0;break}this.setTransparent(e)}}),a}),t("x_ite/Rendering/DependentRenderer",["x_ite/Basic/X3DBaseNode","x_ite/Rendering/X3DRenderObject","x_ite/Bits/TraverseType"],function(t,e,i){"use strict";function r(i){t.call(this,i),e.call(this,i),this.renderObject=null}return r.prototype=Object.assign(Object.create(t.prototype),e.prototype,{constructor:r,initialize:function(){t.prototype.initialize.call(this),e.prototype.initialize.call(this)},isIndependent:function(){return!1},setRenderer:function(t){this.renderObject=t},getBrowser:function(){return this.renderObject.getBrowser()},getLayer:function(){return this.renderObject.getLayer()},getBackground:function(){return this.renderObject.getBackground()},getFog:function(){return this.renderObject.getFog()},getNavigationInfo:function(){return this.renderObject.getNavigationInfo()},getViewpoint:function(){return this.renderObject.getViewpoint()},getLightContainer:function(){return this.renderObject.getLights()[this.lightIndex++]},render:function(t,r,n){switch(t){case i.COLLISION:e.prototype.render.call(this,t,r,n);break;case i.SHADOW:e.prototype.render.call(this,t,r,n);break;case i.DISPLAY:{this.lightIndex=0,e.prototype.render.call(this,t,r,n);const i=this.renderObject.getLights();for(var s=0,a=i.length;s<a;++s)i[s].getModelViewMatrix().pop();break}}}}),r}),t("x_ite/Components/CubeMapTexturing/GeneratedCubeMapTexture",["x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode","x_ite/Rendering/DependentRenderer","x_ite/Rendering/TextureBuffer","x_ite/Bits/X3DConstants","x_ite/Bits/TraverseType","standard/Math/Geometry/Camera","standard/Math/Geometry/ViewVolume","standard/Math/Numbers/Rotation4","standard/Math/Numbers/Vector3","standard/Math/Numbers/Vector4","standard/Math/Numbers/Matrix4","standard/Math/Algorithm"],function(t,e,i,r,n,s,a,o,u,h,d,g,_,x,l){"use strict";function p(t){r.call(this,t),this.addType(a.GeneratedCubeMapTexture),this.renderer=new n(t),this.projectionMatrix=new x,this.modelMatrix=new x,this.viewVolume=new h}var c=[new d(g.zAxis,new g(0,0,-1)),new d(g.zAxis,new g(0,0,1)),new d(g.zAxis,new g(1,0,0)),new d(g.zAxis,new g(-1,0,0)),new d(g.zAxis,new g(0,-1,0)),new d(g.zAxis,new g(0,1,0))],T=[new g(-1,-1,1),new g(-1,-1,1),new g(-1,-1,1),new g(-1,-1,1),new g(1,1,1),new g(1,1,1)],f=new x;return p.prototype=Object.assign(Object.create(r.prototype),{constructor:p,fieldDefinitions:new i([new e(a.inputOutput,"metadata",new t.SFNode),new e(a.inputOutput,"update",new t.SFString("NONE")),new e(a.initializeOnly,"size",new t.SFInt32(128)),new e(a.initializeOnly,"textureProperties",new t.SFNode)]),getTypeName:function(){return"GeneratedCubeMapTexture"},getComponentName:function(){return"CubeMapTexturing"},getContainerField:function(){return"texture"},initialize:function(){r.prototype.initialize.call(this),this.renderer.setup();var t=l.nextPowerOfTwo(this.size_.getValue());if(t>0){t=l.nextPowerOfTwo(t);var e=this.getBrowser().getContext(),i=new Uint8Array(t*t*4);e.bindTexture(this.getTarget(),this.getTexture());for(var n=0;n<6;++n)e.texImage2D(this.getTargets()[n],0,e.RGBA,t,t,0,e.RGBA,e.UNSIGNED_BYTE,i);this.viewport=new _(0,0,t,t),this.frameBuffer=new s(this.getBrowser(),t,t),this.isLive().addInterest("set_live__",this),this.set_live__()}},traverse:function(t,e){t===o.DISPLAY&&"NONE"!==this.update_.getValue()&&this.frameBuffer&&e.isIndependent()&&(e.getGeneratedCubeMapTextures().push(this),this.modelMatrix.assign(e.getModelViewMatrix().get()).multRight(e.getCameraSpaceMatrix().get()))},renderTexture:function(t){this.renderer.setRenderer(t);var e=this.renderer,i=t.getBrowser(),r=t.getLayer(),n=i.getContext(),s=e.getBackground(),a=e.getNavigationInfo(),h=e.getViewpoint(),d=i.getHeadlight(),g=a.headlight_.getValue(),_=a.getNearValue(),p=a.getFarValue(h),m=u.perspective(l.radians(90),_,p,1,1,this.projectionMatrix);this.setTransparent(s.getTransparent()),this.frameBuffer.bind(),e.getViewVolumes().push(this.viewVolume.set(m,this.viewport,this.viewport)),e.getProjectionMatrix().pushMatrix(m),n.bindTexture(this.getTarget(),this.getTexture()),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1);for(var w=0;w<6;++w){n.clear(n.COLOR_BUFFER_BIT),e.getCameraSpaceMatrix().pushMatrix(this.modelMatrix),e.getCameraSpaceMatrix().rotate(c[w]),e.getCameraSpaceMatrix().scale(T[w]);try{e.getViewMatrix().pushMatrix(f.assign(e.getCameraSpaceMatrix().get()).inverse())}catch(t){console.log(t),e.getViewMatrix().pushMatrix(x.Identity)}e.getModelViewMatrix().pushMatrix(f),g&&(d.getModelViewMatrix().pushMatrix(f),d.getModelViewMatrix().multLeft(h.getCameraSpaceMatrix())),r.traverse(o.DISPLAY,e),g&&d.getModelViewMatrix().pop(),e.getModelViewMatrix().pop(),e.getCameraSpaceMatrix().pop(),e.getViewMatrix().pop();var C=this.frameBuffer.readPixels(),M=this.frameBuffer.getWidth(),b=this.frameBuffer.getHeight();n.texImage2D(this.getTargets()[w],0,n.RGBA,M,b,!1,n.RGBA,n.UNSIGNED_BYTE,C)}this.set_textureQuality__(),e.getProjectionMatrix().pop(),e.getViewVolumes().pop(),this.frameBuffer.unbind(),"NEXT_FRAME_ONLY"===this.update_.getValue()&&(this.update_="NONE")},setShaderUniformsToChannel:function(){const t=new Float32Array(16);return function(e,i,n,s){r.prototype.setShaderUniformsToChannel.call(this,e,i,n,s),n.isIndependent()||e.uniformMatrix4fv(i.x3d_ModelViewMatrix,!1,t)}}()}),p}),t("x_ite/Components/CubeMapTexturing/ImageCubeMapTexture",["jquery","x_ite/Fields","x_ite/Basic/X3DFieldDefinition","x_ite/Basic/FieldDefinitionArray","x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode","x_ite/Components/Networking/X3DUrlObject","x_ite/Bits/X3DConstants","standard/Networking/URI","standard/Math/Numbers/Vector2","standard/Math/Algorithm","x_ite/DEBUG"],function(t,e,i,r,n,s,a,o,u,h,d){"use strict";function g(t){n.call(this,t),s.call(this,t),this.addType(a.ImageCubeMapTexture),this.urlStack=new e.MFString}var _=new Uint8Array([255,255,255,255]),x=[new u(1,1),new u(3,1),new u(0,1),new u(2,1),new u(1,0),new u(1,2)];return g.prototype=Object.assign(Object.create(n.prototype),s.prototype,{constructor:g,fieldDefinitions:new r([new i(a.inputOutput,"metadata",new e.SFNode),new i(a.inputOutput,"url",new e.MFString),new i(a.initializeOnly,"textureProperties",new e.SFNode)]),getTypeName:function(){return"ImageCubeMapTexture"},getComponentName:function(){return"CubeMapTexturing"},getContainerField:function(){return"texture"},initialize:function(){n.prototype.initialize.call(this),s.prototype.initialize.call(this);var e=this.getBrowser().getContext();e.bindTexture(this.getTarget(),this.getTexture());for(var i=0;i<6;++i)e.texImage2D(this.getTargets()[i],0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,_);this.url_.addInterest("set_url__",this),this.canvas=t("<canvas></canvas>"),this.image=t("<img></img>"),this.image.on("load",this.setImage.bind(this)),this.image.on("error",this.setError.bind(this)),this.image.bind("abort",this.setError.bind(this)),this.image[0].crossOrigin="Anonymous",this.requestImmediateLoad()},set_url__:function(){this.setLoadState(a.NOT_STARTED_STATE),this.requestImmediateLoad()},requestImmediateLoad:function(){this.checkLoadState()!==a.COMPLETE_STATE&&this.checkLoadState()!==a.IN_PROGRESS_STATE&&(this.setLoadState(a.IN_PROGRESS_STATE),this.urlStack.setValue(this.url_),this.loadNext())},loadNext:function(){if(0===this.urlStack.length)return this.clearTexture(),void this.setLoadState(a.FAILED_STATE);this.URL=new o(this.urlStack.shift()),this.URL=this.getExecutionContext().getURL().transform(this.URL),this.image.attr("src",this.URL)},setError:function(){"data"!==this.URL.scheme&&console.warn("Error loading image:",this.URL.toString()),this.loadNext()},setImage:function(){d&&"data"!==this.URL.scheme&&console.info("Done loading image cube map texture:",this.URL.toString());try{var t=this.image[0],e=t.width,i=t.height,r=Math.floor(e/4),n=Math.floor(i/3),s=this.canvas[0],o=s.getContext("2d");h.isPowerOfTwo(r)&&h.isPowerOfTwo(n)&&4*r===e&&3*n===i?(s.width=e,s.height=i,o.drawImage(t,0,0)):(r=h.nextPowerOfTwo(r),n=h.nextPowerOfTwo(n),e=4*r,i=3*n,s.width=e,s.height=i,o.drawImage(t,0,0,t.width,t.height,0,0,e,i));var u=this.getBrowser().getContext(),g=!0;u.bindTexture(this.getTarget(),this.getTexture()),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1);for(var _=0;_<6;++_){var l=o.getImageData(x[_].x*r,x[_].y*n,r,n).data;if(g)for(var p=3;p<l.length;p+=4)if(255!==l[p]){g=!1;break}u.texImage2D(this.getTargets()[_],0,u.RGBA,r,n,!1,u.RGBA,u.UNSIGNED_BYTE,new Uint8Array(l))}this.set_textureQuality__(),this.setTransparent(!g),this.setLoadState(a.COMPLETE_STATE)}catch(t){console.log(t.message),this.setError()}}}),g}),t(["x_ite/Components","x_ite/Components/CubeMapTexturing/ComposedCubeMapTexture","x_ite/Components/CubeMapTexturing/GeneratedCubeMapTexture","x_ite/Components/CubeMapTexturing/ImageCubeMapTexture","x_ite/Components/CubeMapTexturing/X3DEnvironmentTextureNode"],function(t,e,i,r,n){"use strict";t.addComponent({name:"CubeMapTexturing",types:{ComposedCubeMapTexture:e,GeneratedCubeMapTexture:i,ImageCubeMapTexture:r},abstractTypes:{X3DEnvironmentTextureNode:n}})})}();
